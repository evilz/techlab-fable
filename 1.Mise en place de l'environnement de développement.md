# Mise en place de l'environnement de d√©veloppement


> **Objectif**: nous allons installer et mettre en place pas √† pas l'environnement de compilation pour `Fable` en partant d'un r√©pertoire vide pour mieux comprendre le fonctionnement.

## Conditions pr√©alables

- **node** - N√©cessaire pour ex√©cuter le code JavaScript
- **yarn** - Utilis√© pour les d√©pendances du c√¥t√© JavaScript
- **.NET Core SDK** - Utilis√© pour la gestion de projet
- **La famille de plugins Ionide et VS Code**  - Non requis, mais fortement recommand√© pour am√©liorer l'exp√©rience des d√©veloppeurs.


## Fonctionnement 

![](assets/schema.png)

Le sch√©ma ci-dessus repr√©sente l'orchestration des diff√©rentes t√¢ches utilis√©es par Fable.

1. Via la CLI dotnet on va ex√©cuter la commande Fable
2. Un serveur de compilation Fable d√©marre et √©coute les changements sur les sources F# pour compiler le projet et en extraire un arbre de syntaxe abstraite (AST).
- 3. Babel prend cette AST en entr√© et le transpile en module ES6.
- 4. Pour finir webpack va "bundler" l'ensemble des modules en un fichier pour node ou pour le browser. 


> üí¨ Par d√©faut le serveur fable utilise le port 61225 pour communiquer.


## Structure des r√©pertoires

Commencez par cr√©er un nouveau r√©pertoire pour le projet :
Dans ce r√©pertoire cr√©ez un dossier vide appel√© .paket qui va contenir le gestionnaire de paquets nuget Paket.

```powershell
mkdir fable-from-scratch
cd fable-from-scratch
mkdir ./.paket
```
## Cr√©ation du projet F#

Nous allons cr√©er une nouvelle application F# de type console en utilisant la CLI de dotnet : 

```powersell
dotnet new console -lang f#
```

Testez la compilation et le bon fonctionnement :
```powersell
dotnet restore
dotnet run
```


### Paket

Paket est indispensable √† l'heure actuelle pour le bon fonctionnement de Fable.
C'est un gestionnaire de paquets alternatif √† nuget qui apporte un grand nombre de fonctionnalit√©s comme l'utilisation d'un fichier `paket.lock` pour garantir une restauration des m√™mes versions des d√©pendances pour l'ensemble des d√©veloppeurs.

Par convention, les binaires de Paket sont install√©s dans le r√©pertoire .paket que nous avons cr√©√© ci-dessus.

T√©l√©chargez le fichier [paket.bootstrapper.exe](
https://github.com/fsprojects/Paket/releases/download/5.148.0/paket.bootstrapper.exe)
, puis renommez-le en paket.exe et copiez-le dans le dossier .paket. Cela active le "mode magique" qui permet de mettre √† jour automatiquement paket sans commande suppl√©mentaire.

> Sous windows, il est n√©cessaire de d√©bloquer l'ex√©cution de l'application : clic droit -> propri√©t√©s -> d√©bloquer

> Sous linux/mac paket se lance avec mono :  `mono ./.paket/paket.exe`

Nous allons basculer la restauration des paquets depuis Nuget vers Paket. 
Paket dispose d'une commande de migration :

```
./.paket/paket.exe convert-from-nuget
```

Apr√®s l'√©x√©cution vous allez obtenir les fichiers et r√©pertoire suivant :

- üìÅ **packages**: Ce dossier va contenir toutes les d√©pendances que vous t√©l√©chargez via paket.
- üìÑ **paket.references**: Ce fichier se trouve √† la racine de votre projet. Il contient les r√©f√©rences utilis√©es par le projet.
- üìÑ **paket.dependencies**: Ce fichier est plac√© √† la racine de la solution et d√©finie la liste de vos d√©pendances **directes**. 

Les fichiers paket sont facilement √©ditables √† la main ou en utilisant les commandes de paket : `paket add` et `paket remove`.

Ajoutons maintenant les d√©pendances de fable.
Utilisez paket pour rechercher les paquets dont le nom contient "Fable" :


```powershell
./.paket/paket.exe find-packages Fable

Paket version 5.148.0
Fable.React
Fable.Core
Fable.React.Native
Fable.FCS
Fable.Ava
Fable.Sinon
Fable.Mqtt
Fable.Import.Mocha
Fable.Inferno
Fable.Chessie
Fable.Import.Pixi
dotnet-fable
Fable.Compiler
Fable.PowerPack
Fable.Import.Browser
Fable.JsonConverter
Fable.Elmish
Fable.Elmish.React
Fable.Import.Node
Fable.Template
Performance:
 - Average Request Time: 1 second
 - Number of Requests: 3
 - Runtime: 5 seconds
```

Nous allons ajouter `Fable.Core`et `Fable.Import.Browser` √† notre projet.

```
./.paket/paket.exe add Fable.Core --project ./fable-from-scratch.fsproj
./.paket/paket.exe add Fable.Import.Browser --project ./fable-from-scratch.fsproj

./.paket/paket.exe install
```

Les deux d√©pendances ont √©t√© ajout√©es dans les fichiers paket et la commande `paket install` a d√©clench√©e le t√©l√©chargement et a √©galement ajout√©e une cible de restauration au fichier .fsproj. Cela vous permet de restaurer les d√©pendances de paquets en effectuant simplement une restauration dotnet (`dotnet restore`).

```xml
  <Import Project=".paket\Paket.Restore.targets" />
```


> üí¨  Il est possible de mettre √† jour les paquets en utilisant > les commandes suivantes: 
> `./.paket/paket.exe outdated` et `./.paket.exe update`


## Fable CLI

Nous allons maintenant installer une extension √† la CLI dotnet qui est paquag√© sous forme de nuget.

Ajoutez une r√©f√©rence de type DotNetCliToolReference dans le fichier de projet `fable-from-scratch.fsproj`


```xml
<?xml version="1.0" encoding="utf-8"?>
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>netcoreapp2.0</TargetFramework>
  </PropertyGroup>
  <ItemGroup>
    <Compile Include="Program.fs" />
    <DotNetCliToolReference Include="dotnet-fable" Version="1.3.*" />
  </ItemGroup>
  <Import Project=".paket\Paket.Restore.targets" />
</Project>
```

Il ne reste plus qu'√† lancer une restauration :
```
dotnet restore
```

Fable est maintenant install√© !!üôå
Testez en ex√©cutant la commande suivante :

```
dotnet fable --help

Fable F# to JS compiler (1.3.10)
Usage: dotnet fable [command] [script] [fable arguments] [-- [script arguments]]

Commands:
  -h|--help           Show help
  --version           Print version
  start               Start Fable daemon
  npm-run             Run Fable while an npm script is running
  yarn-run            Run Fable while a yarn script is running
  node-run            Run Fable while a node script is running
  shell-run           Run Fable while a shell script is running
  webpack             Start Fable daemon, invoke Webpack and shut it down
  webpack-dev-server  Run Fable while Webpack development server is running

Fable arguments:
  --timeout           Stop the daemon if timeout (ms) is reached
  --port              Port number (default 61225) or "free" to choose a free port
  --verbose           Print more info during execution

To pass arguments to the script, write them after `--`. Example:

    dotnet fable npm-run build --port free -- -p --config webpack.production.js

You can use shortcuts for npm and yarn scripts in the following way:

    dotnet fable yarn-start       # Same as `dotnet fable yarn-run start`
```


## Mise en place de l'environnement JS

La partie dotnet est en place, il faut maintenant installer l'environnement javascript/node.

Dans cet atelier nous allons utiliser trois briques JavaScript :

- Babel
- Webpack
- Fable-Loader

Il est possible d'utiliser une autre brique pour cr√©er le bundle js, comme `rollup` ou `parcel`, mais webpack est pour l'instant plus mature et plus stable.

De plus `yarn` va √™tre utilis√© √† la place de npm, pour des questions d'efficacit√©.

Initiez le fichier package.json et ajoutez les d√©pendances pour babel, webpack et fable


```
yarn init -y
yarn add -D babel-runtime babel-core babel-loader babel-plugin-transform-runtime babel-preset-es2015 babel-preset-env fable-loader webpack webpack-cli webpack-dev-server
```


## configuration du bundler (webpack)

Webpack n√©cessite un fichier de configuration `webpack.config.js`.

```
echo $null >> webpack.config.js
```

Copiez ce contenu dans le fichier 

```js
var path = require("path");
var webpack = require("webpack");
var fableUtils = require("fable-utils");

function resolve(filePath) {
  return path.join(__dirname, filePath)
}

var babelOptions = fableUtils.resolveBabelOptions({
  presets: [
    ["env", {
      "targets": {
        "browsers": "> 1%"
      },
      "modules": false
    }]
  ],
});

var isProduction = process.argv.indexOf("-p") >= 0;
console.log("Bundling for " + (isProduction ? "production" : "development") + "...");

module.exports = {
  devtool: "source-map",
  entry: resolve('./fable-from-scratch.fsproj'),
  output: {
    filename: 'bundle.js',
    path: resolve('./public'),
  },
  resolve: {
    modules: [resolve("./node_modules/")]
  },
  devServer: {
    contentBase: resolve('./public'),
    port: 8080
  },
  module: {
    rules: [
      {
        test: /\.fs(x|proj)?$/,
        use: {
          loader: "fable-loader",
          options: {
            babel: babelOptions,
            define: isProduction ? [] : ["DEBUG"]
          }
        }
      },
      {
        test: /\.js$/,
        exclude: /node_modules/,
        use: {
          loader: 'babel-loader',
          options: babelOptions
        },
      }
    ]
  }
};
```

Pour r√©sumer simplement la config, on prend en entr√© le fichier `./fable-from-scratch.fsproj` et en sortie on g√©n√®re le fichier `./public/bundle.js`.
Bien sur on ajoute le loader `fable-loader` √† webpack pour qu'il comprenne quoi faire des fichier .fsproj et .fs(x).


## npm/yarn script

Npm et yarn propose au travers du fichier `package.json`de d√©finir des commande √† ex√©cuter via un alias `install`, `build` ou autre

Nous allons ajouter quelques commandes pour lancer webpack et webpack-dev.

Ajouter une section script dans votre fichier package.json

```json
"scripts": {
    "build": "webpack -p",
    "start": "webpack-dev-server",
  },
```

## Program

Toutes les d√©pendances et outils sont maintenant en place, il ne reste plus qu'√† faire un programme.

Remplacez le contenu du fichier `Program.fs` par celui-ci :


```fsharp
module Program
open Fable.Core
printfn "Hello Fable"
```

Ce code est du pur F#. Il ne reste plus qu'√† le compiler en javascript.


```
dotnet fable yarn-build

Fable (1.3.10) daemon started on port 61225
CWD: D:\GITHUB\Fable-workshop\fable-from-scratch
cmd /C yarn run build
yarn run v0.27.5
$ webpack -p
Bundling for production...
Parsing ./fable-from-scratch.fsproj...
fable: Compiled fable-from-scratch.fsproj
fable: Compiled Program.fs
Hash: 8176f0debf0ece5a8465
Version: webpack 4.1.0
Time: 7567ms
Built at: 2018-3-6 19:25:18
        Asset      Size  Chunks             Chunk Names
    bundle.js  6.81 KiB       0  [emitted]  main
bundle.js.map  28.3 KiB       0  [emitted]  main
Entrypoint main = bundle.js bundle.js.map
   [0] ./fable-from-scratch.fsproj + 6 modules 54.1 KiB {0} [built]
       | ./fable-from-scratch.fsproj 29 bytes [built]
       | ./Program.fs 142 bytes [built]
       | C:/Users/vbourdon/.nuget/packages/fable.core/1.3.9/fable-core/String.js 17.6 KiB [built]
       | C:/Users/vbourdon/.nuget/packages/fable.core/1.3.9/fable-core/Date.js 11.4 KiB [built]
       | C:/Users/vbourdon/.nuget/packages/fable.core/1.3.9/fable-core/RegExp.js 3.63 KiB [built]
       | C:/Users/vbourdon/.nuget/packages/fable.core/1.3.9/fable-core/Util.js 21.1 KiB [built]
       | C:/Users/vbourdon/.nuget/packages/fable.core/1.3.9/fable-core/Symbol.js 224 bytes [built]
Done in 8.73s.
Closing Fable daemon...
```

Le fichier `./public/bundle.js` a √©t√© cr√©√©, ex√©cutons-le en utilisant NodeJs

```
node ./public/bundle.js

Hello Fable üêâ
```


# F√©licitations üèÜ

Vous avez r√©ussi √† mettre en place **from scratch** un environnement Fable. 
Dans le prochain atelier nous allons utiliser un template de projet pour gagner du temps et ne pas r√©inventer la roue.
